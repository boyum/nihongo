---
import megSelv from '../data/meg-selv.json';
import megSelvTemplates from '../data/meg-selv-templates.json';
import mat from '../data/mat.json';
import matTemplates from '../data/mat-templates.json';
import tog from '../data/tog.json';
import italia from '../data/italia.json';
import italiaTemplates from '../data/italia-templates.json';
import hiroshima from '../data/hiroshima.json';
import dagligeRutiner from '../data/daglige-rutiner.json';
import dagligeRutinerTemplates from '../data/daglige-rutiner-templates.json';
import hjemme from '../data/hjemme.json';
import hjemmeTemplates from '../data/hjemme-templates.json';
import skole from '../data/skole.json';
import skoleTemplates from '../data/skole-templates.json';
import jobb from '../data/jobb.json';
import jobbTemplates from '../data/jobb-templates.json';
import familie from '../data/familie.json';
import familieTemplates from '../data/familie-templates.json';

// Funksjon for å generere dynamiske setninger fra maler
function generateSentencesFromTemplates(category: any) {
  if (!category.sentenceTemplates) {
    return category;
  }

  const sentences = category.sentenceTemplates.map((template: any) => {
    const words: any[] = [];
    let answerParts: string[] = [];
    const selectedOptions: any = {};

    template.template.forEach((item: any, index: number) => {
      if (item.type === 'variable') {
        // Velg et tilfeldig alternativ
        const randomOption = item.options[Math.floor(Math.random() * item.options.length)];
        selectedOptions[index] = randomOption;

        // Legg til hovedordet
        words.push({
          furigana: randomOption.furigana,
          kanji: randomOption.kanji,
          romaji: randomOption.romaji,
          tooltip: randomOption.tooltip,
          isParticle: randomOption.isParticle || false
        });

        // Legg til ekstra ord hvis de finnes (f.eks. partikler eller hjelpeverb)
        if (randomOption.extra) {
          randomOption.extra.forEach((extraWord: any) => {
            words.push(extraWord);
          });
        }

        // Legg til verb hvis det finnes
        if (randomOption.verb) {
          words.push({
            furigana: "を",
            kanji: "を",
            romaji: "o",
            tooltip: "[objekt-partikkel]",
            isParticle: true
          });
          words.push(randomOption.verb);
        }

        // Lagre oversettelser
        if (randomOption.translations) {
          answerParts = randomOption.translations;
        }
      } else {
        // Vanlig ord, ikke variabelt
        words.push(item);
      }
    });

    // Hvis ingen spesifikke oversettelser er definert, bruk standard
    if (answerParts.length === 0) {
      answerParts = ["standardoversettelse"];
    }

    return {
      id: template.id,
      words: words,
      answers: answerParts
    };
  });

  return {
    ...category,
    sentences: sentences
  };
}

// Generer dynamiske setninger for alle kategorier med maler
const megSelvGenerated = generateSentencesFromTemplates(megSelvTemplates);
const matGenerated = generateSentencesFromTemplates(matTemplates);
const italiaGenerated = generateSentencesFromTemplates(italiaTemplates);
const dagligeRutinerGenerated = generateSentencesFromTemplates(dagligeRutinerTemplates);
const hjemmeGenerated = generateSentencesFromTemplates(hjemmeTemplates);
const skoleGenerated = generateSentencesFromTemplates(skoleTemplates);
const jobbGenerated = generateSentencesFromTemplates(jobbTemplates);
const familieGenerated = generateSentencesFromTemplates(familieTemplates);

const categories = [megSelvGenerated, matGenerated, tog, italiaGenerated, hiroshima, dagligeRutinerGenerated, hjemmeGenerated, skoleGenerated, jobbGenerated, familieGenerated];
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>日本語の練習 - Japansk øving</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        max-width: 900px;
        width: 100%;
        margin: 40px auto;
        padding: 1rem;
        line-height: 1.6;
        background-color: #f5f5f5;
      }

      .container {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }

      .category {
        margin: 40px 0;
      }

      .category-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
      }

      .category-header:hover {
        opacity: 0.9;
      }

      .toggle-icon {
        font-size: 24px;
        transition: transform 0.3s;
      }

      .category.collapsed .toggle-icon {
        transform: rotate(-90deg);
      }

      .category-content {
        display: block;
      }

      .category.collapsed .category-content {
        display: none;
      }

      .sentence-block {
        margin: 25px 0;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }

      .sentence-header {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .sentence {
        margin: 25px 0;
        font-size: 18px;
        flex: 1;
      }

      .play-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #3498db;
        transition: all 0.2s;
        border-radius: 4px;
        flex-shrink: 0;
      }

      .play-btn:hover {
        color: #2980b9;
        background-color: rgba(52, 152, 219, 0.1);
      }

      .play-btn:active {
        transform: scale(0.95);
      }

      .play-btn.playing {
        color: #e74c3c;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .play-sentence {
        margin-top: 25px;
      }

      .play-word {
        position: absolute;
        top: -18px;
        left: 50%;
        transform: translateX(-50%);
        padding: 2px;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .word:hover .play-word {
        opacity: 1;
      }

      .word {
        display: inline-block;
        margin: 0 3px;
        cursor: help;
        position: relative;
        vertical-align: top;
      }

      .furigana {
        display: block;
        font-size: 12px;
        color: #e74c3c;
        text-align: center;
        line-height: 1.2;
        min-height: 14.4px;
      }

      .kanji {
        display: inline-block;
        font-size: 24px;
        text-align: center;
        line-height: 1.2;
        vertical-align: bottom;
      }

      .romaji {
        display: block;
        font-size: 11px;
        color: #7f8c8d;
        text-align: center;
        line-height: 1.2;
      }

      .hide-romaji .romaji {
        display: none;
      }

      .settings-panel {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
      }

      .settings-panel label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 15px;
        color: #2c3e50;
      }

      .settings-panel input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .tooltip {
        visibility: hidden;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2c3e50;
        color: white;
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        line-height: 1.5;
      }

      .tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #2c3e50;
      }

      .word:hover .tooltip {
        visibility: visible;
      }

      .particle {
        color: #27ae60;
        font-weight: bold;
      }

      .translation-input {
        width: 100%;
        margin-top: 15px;
        padding: 10px;
        font-size: 15px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        transition: border-color 0.3s;
      }

      .translation-input:focus {
        outline: none;
        border-color: #3498db;
      }

      .translation-input.correct {
        border-color: #27ae60;
        background-color: #d5f4e6;
      }

      .translation-input.almost {
        border-color: #f39c12;
        background-color: #fef5e7;
      }

      .translation-input.incorrect {
        border-color: #e74c3c;
        background-color: #fadbd8;
      }

      .feedback {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
        display: none;
      }

      .feedback.show {
        display: block;
      }

      .feedback.correct {
        background-color: #d5f4e6;
        color: #27ae60;
        border: 1px solid #27ae60;
      }

      .feedback.almost {
        background-color: #fef5e7;
        color: #d68910;
        border: 1px solid #f39c12;
      }

      .feedback.incorrect {
        background-color: #fadbd8;
        color: #c0392b;
        border: 1px solid #e74c3c;
      }

      .progress-bar {
        margin: 20px 0;
        background-color: #ecf0f1;
        border-radius: 10px;
        height: 30px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>日本語の練習 (にほんごのれんしゅう) - Japansk øving</h1>

      <div class="settings-panel">
        <label>
          <input type="checkbox" id="showRomajiToggle" />
          <span>Vis romaji (ローマ字を表示)</span>
        </label>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressBar"></div>
      </div>

      {categories.map((category) => (
        <div class="category">
          <div class="category-header" onclick="toggleCategory(this)">
            <span>{category.emoji} {category.categoryName} ({category.categoryNameJapanese})</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="category-content">
            {category.sentences.map((sentence) => (
              <div class="sentence-block" data-answer={sentence.answers.join('|')}>
                <div class="sentence-header">
                  <button class="play-btn play-sentence" title="Spill av hele setningen">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </button>
                  <div class="sentence">
                    {sentence.words.map((word) => (
                      <span class={word.isParticle ? 'word' : 'word'}>
                        <button class="play-btn play-word" data-text={word.kanji} title={`Spill av: ${word.romaji}`}>
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                          </svg>
                        </button>
                        <span class="furigana">{word.furigana}</span>
                        <span class={word.isParticle ? 'kanji particle' : 'kanji'}>{word.kanji}</span>
                        <span class="romaji">{word.romaji}</span>
                        <span class="tooltip" set:html={word.tooltip}></span>
                      </span>
                    ))}
                    <span class="kanji">。</span>
                  </div>
                </div>
                <input type="text" class="translation-input" placeholder="Skriv hva denne setningen betyr på norsk..." />
                <div class="feedback"></div>
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>

    <script>
      // Levenshtein distance algoritme
      function levenshteinDistance(str1: string, str2: string): number {
        const len1 = str1.length;
        const len2 = str2.length;
        const matrix: number[][] = [];

        for (let i = 0; i <= len1; i++) {
          matrix[i] = [i];
        }

        for (let j = 0; j <= len2; j++) {
          matrix[0][j] = j;
        }

        for (let i = 1; i <= len1; i++) {
          for (let j = 1; j <= len2; j++) {
            if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
              matrix[i][j] = matrix[i - 1][j - 1];
            } else {
              matrix[i][j] = Math.min(
                matrix[i - 1][j - 1] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j] + 1,
              );
            }
          }
        }

        return matrix[len1][len2];
      }

      // Normaliser tekst
      function normalizeText(text: string): string {
        return text
          .toLowerCase()
          .trim()
          .replace(/[.,!?;:]/g, "")
          .replace(/\s+/g, " ")
          .replace(/å/g, "a")
          .replace(/æ/g, "ae")
          .replace(/ø/g, "o");
      }

      // Sjekk svar
      function checkAnswer(userAnswer: string, correctAnswers: string[]): { score: number; type: string; bestMatch: string } {
        const normalizedUser = normalizeText(userAnswer);

        if (normalizedUser.length === 0) {
          return { score: 0, type: "empty", bestMatch: "" };
        }

        let bestScore = 0;
        let bestMatch = "";

        correctAnswers.forEach((correctAnswer) => {
          const normalizedCorrect = normalizeText(correctAnswer);

          if (normalizedUser === normalizedCorrect) {
            bestScore = 1.0;
            bestMatch = correctAnswer;
            return;
          }

          if (
            normalizedUser.includes(normalizedCorrect) ||
            normalizedCorrect.includes(normalizedUser)
          ) {
            const score = 0.85;
            if (score > bestScore) {
              bestScore = score;
              bestMatch = correctAnswer;
            }
          }

          const distance = levenshteinDistance(
            normalizedUser,
            normalizedCorrect,
          );
          const maxLen = Math.max(
            normalizedUser.length,
            normalizedCorrect.length,
          );
          const similarity = 1 - distance / maxLen;

          if (similarity > bestScore) {
            bestScore = similarity;
            bestMatch = correctAnswer;
          }
        });

        let type: string;
        if (bestScore >= 0.9) {
          type = "correct";
        } else if (bestScore >= 0.7) {
          type = "almost";
        } else {
          type = "incorrect";
        }

        return { score: bestScore, type: type, bestMatch: bestMatch };
      }

      // Toggle kategori
      function toggleCategory(header: HTMLElement): void {
        const category = header.parentElement;
        category?.classList.toggle("collapsed");
      }

      // Oppdater progress bar
      function updateProgress(): void {
        const allInputs = document.querySelectorAll(".translation-input");
        const correctInputs = document.querySelectorAll(
          ".translation-input.correct",
        );
        const progressBar = document.getElementById("progressBar");
        const percentage =
          allInputs.length > 0
            ? Math.round((correctInputs.length / allInputs.length) * 100)
            : 0;
        if (progressBar) {
          progressBar.style.width = `${percentage}%`;
        }
      }

      // Håndter alle input-felt
      document.querySelectorAll(".sentence-block").forEach((block) => {
        const input = block.querySelector(".translation-input") as HTMLInputElement;
        const feedback = block.querySelector(".feedback") as HTMLElement;
        const correctAnswersStr = block.getAttribute("data-answer") || "";
        const correctAnswers = correctAnswersStr.split("|");

        input.addEventListener("keypress", (e: KeyboardEvent) => {
          if (e.key === "Enter") {
            checkUserAnswer();
          }
        });

        input.addEventListener("input", () => {
          input.classList.remove("correct", "almost", "incorrect");
          feedback.classList.remove("show", "correct", "almost", "incorrect");
        });

        function checkUserAnswer(): void {
          const userAnswer = input.value;
          const result = checkAnswer(userAnswer, correctAnswers);

          input.classList.remove("correct", "almost", "incorrect");
          feedback.classList.remove("show", "correct", "almost", "incorrect");

          if (result.type === "empty") {
            return;
          }

          input.classList.add(result.type);
          feedback.classList.add("show", result.type);

          if (result.type === "correct") {
            feedback.innerHTML = "✓ Riktig! Veldig bra!";
          } else if (result.type === "almost") {
            feedback.innerHTML = `≈ Nesten riktig! Du er på rett spor.<br><small>Et eksempel på korrekt svar: "${result.bestMatch}"</small>`;
          } else {
            feedback.innerHTML = `✗ Ikke helt riktig.<br><small>Riktig svar: "${result.bestMatch}"</small>`;
          }

          updateProgress();
        }
      });

      // Initialiser progress bar
      updateProgress();

      // Håndter romaji toggle
      const showRomajiToggle = document.getElementById("showRomajiToggle") as HTMLInputElement;
      const container = document.querySelector(".container") as HTMLElement;

      // Last inn brukerens preferanse fra localStorage (default: true = vis romaji)
      const savedPreference = localStorage.getItem("showRomaji");
      const shouldShowRomaji = savedPreference === null ? true : savedPreference === "true";

      showRomajiToggle.checked = shouldShowRomaji;
      if (!shouldShowRomaji) {
        container.classList.add("hide-romaji");
      }

      showRomajiToggle.addEventListener("change", () => {
        if (showRomajiToggle.checked) {
          container.classList.remove("hide-romaji");
          localStorage.setItem("showRomaji", "true");
        } else {
          container.classList.add("hide-romaji");
          localStorage.setItem("showRomaji", "false");
        }
      });

      // Make toggleCategory available globally
      (window as any).toggleCategory = toggleCategory;

      // Text-to-Speech funksjonalitet
      const synth = window.speechSynthesis;
      let currentUtterance: SpeechSynthesisUtterance | null = null;

      // Finn japansk stemme (kvinnelig hvis tilgjengelig)
      function getJapaneseVoice(): SpeechSynthesisVoice | null {
        const voices = synth.getVoices();
        // Prøv å finne en kvinnelig japansk stemme først
        let voice = voices.find(v => v.lang.startsWith('ja') && v.name.includes('Female'));
        if (!voice) {
          // Hvis ikke, finn en hvilken som helst japansk stemme
          voice = voices.find(v => v.lang.startsWith('ja'));
        }
        return voice || null;
      }

      // Funksjon for å spille av tekst
      function speakText(text: string, button: HTMLElement): void {
        // Stopp eventuell pågående tale
        if (synth.speaking) {
          synth.cancel();
          document.querySelectorAll('.play-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
          });
        }

        const utterance = new SpeechSynthesisUtterance(text);
        const voice = getJapaneseVoice();

        if (voice) {
          utterance.voice = voice;
        }
        utterance.lang = 'ja-JP';
        utterance.rate = 0.85; // Litt langsommere for bedre forståelse
        utterance.pitch = 1.1; // Litt høyere tone for kvinnelig stemme

        button.classList.add('playing');
        currentUtterance = utterance;

        utterance.onend = () => {
          button.classList.remove('playing');
          currentUtterance = null;
        };

        utterance.onerror = () => {
          button.classList.remove('playing');
          currentUtterance = null;
          console.error('Tale-syntese feil');
        };

        synth.speak(utterance);
      }

      // Last inn stemmer (nødvendig for noen nettlesere)
      if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = getJapaneseVoice;
      }

      // Legg til event listeners for alle play-knapper
      document.querySelectorAll('.play-word').forEach((button) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const text = (button as HTMLElement).getAttribute('data-text');
          if (text) {
            speakText(text, button as HTMLElement);
          }
        });
      });

      document.querySelectorAll('.play-sentence').forEach((button) => {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const sentenceBlock = (button as HTMLElement).closest('.sentence-block');
          if (sentenceBlock) {
            const words = sentenceBlock.querySelectorAll('.word .kanji');
            let fullText = '';
            words.forEach(word => {
              fullText += (word as HTMLElement).textContent || '';
            });
            // Legg til punktum
            fullText += '。';
            speakText(fullText, button as HTMLElement);
          }
        });
      });
    </script>
  </body>
</html>
